<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des cours</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f4f6fb;
      color: #222;
    }
    .container {
      max-width: 700px;
      margin: 32px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 32px 24px;
    }
    h1 {
      text-align: center;
      color: #2a5d9f;
      margin-bottom: 32px;
      font-size: 2.2em;
      letter-spacing: 1px;
    }
    #filter-input {
      margin-bottom: 24px;
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bcd0ee;
      font-size: 1em;
      box-shadow: 0 2px 8px rgba(42,93,159,0.05);
      transition: border 0.2s;
    }
    #filter-input:focus {
      border: 1.5px solid #2a5d9f;
      outline: none;
    }
    .cours {
      border: 1px solid #e3eaf5;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: linear-gradient(90deg,#f9fbff 80%,#eaf2fb 100%);
      box-shadow: 0 2px 12px rgba(42,93,159,0.07);
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .cours:hover {
      box-shadow: 0 6px 24px rgba(42,93,159,0.13);
      transform: translateY(-2px) scale(1.01);
    }
    .cours h2 {
      margin: 0 0 10px 0;
      color: #2a5d9f;
      font-size: 1.3em;
    }
    .cours strong {
      color: #3a7bd5;
    }
    .etudiants {
      margin-left: 0;
      padding-left: 18px;
      margin-top: 6px;
    }
    .etudiants li {
      margin-bottom: 2px;
      font-size: 1em;
      color: #222;
    }
    @media (max-width: 768px) {
      .container { padding: 16px 6px; }
      h1 { font-size: 1.5em; }
      .cours { padding: 12px; }
    }
    @media (max-width: 400px) {
      .container { padding: 4px; }
      h1 { font-size: 1.1em; }
      .cours h2 { font-size: 1em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Liste des cours</h1>
    <input type="text" id="filter-input" placeholder="Filtrer par titre ou identifiant...">
    <div id="cours-list"></div>
  </div>

  <script>
    // URL de l'API Omeka S
    const API_BASE = 'http://localhost/omeka_exam/api';
    const API_KEY_ID = 'NrzdvQnYPeEhGGOqupu9xYLjmSVSF5ee';
    const API_KEY_SECRET = 'dvBeCMOZXInzu4QZuVs5q5lYy5OqrLD1';

    function buildApiUrl(path) {
      const url = new URL(API_BASE + path);
      url.searchParams.set('key_identity', API_KEY_ID);
      url.searchParams.set('key_credential', API_KEY_SECRET);
      return url.toString();
    }

    async function apiGet(path) {
      const url = buildApiUrl(path);
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) throw new Error(`GET ${url} → ${res.status} ${res.statusText}`);
      return res.json();
    }

    // Récupère les cours et les étudiants liés
    async function getCoursEtudiants() {
      // Cours : resource_class_id=107 (exemple, à adapter selon ta config)
      const cours = await apiGet('/items?resource_class_id=107');
      // Étudiants : resource_class_id=106
      const etudiants = await apiGet('/items?resource_class_id=106');
      // On récupère aussi toutes les évaluations pour faire le lien
      const evals = await apiGet('/items?resource_class_id=108');
      // On mappe les étudiants par identifiant
      const etuMap = {};
      etudiants.forEach(e => {
        const nom = e['dcterms:title']?.[0]?.['@value'] || '(sans nom)';
        const identifiant = e['dcterms:identifier']?.[0]?.['@value'] || '';
        etuMap[identifiant] = nom;
      });
      // On mappe les étudiants inscrits à chaque cours via les évaluations
      const coursList = cours.map(c => {
        const idCours = c['dcterms:identifier']?.[0]?.['@value'] || '';
        const titre = c['dcterms:title']?.[0]?.['@value'] || '(sans titre)';
        // On cherche les évaluations liées à ce cours
        const evalsCours = evals.filter(ev => (ev['exam:aPourCours']?.[0]?.['@value'] || '') === idCours);
        // On récupère les identifiants étudiants
        const etudiantsInscrits = evalsCours.map(ev => {
          const idEtu = ev['exam:aPourEtudiant']?.[0]?.['@value'] || '';
          return etuMap[idEtu] ? etuMap[idEtu] + ' (' + idEtu + ')' : idEtu;
        });
        return { id: idCours, titre, etudiants: etudiantsInscrits };
      });
      return coursList;
    }

    // Filtre et affiche la liste des cours dynamiquement
    async function showCours() {
      const coursList = document.getElementById('cours-list');
      const filterText = document.getElementById('filter-input').value;
      coursList.innerHTML = '<span class="hint">Chargement…</span>';
      try {
        const cours = await getCoursEtudiants();
        const filtered = !filterText ? cours : cours.filter(c =>
          c.titre.toLowerCase().includes(filterText.toLowerCase()) ||
          c.id.toLowerCase().includes(filterText.toLowerCase())
        );
        coursList.innerHTML = '';
        if (filtered.length === 0) {
          coursList.innerHTML = '<span class="hint">Aucun cours trouvé.</span>';
          return;
        }
        filtered.forEach(c => {
          const div = document.createElement('div');
          div.className = 'cours';
          div.innerHTML = `
            <h2>${c.titre}</h2>
            <strong>Identifiant :</strong> ${c.id}<br>
            <strong>Étudiants inscrits :</strong>
            <ul class="etudiants">
              ${c.etudiants.length ? c.etudiants.map(e => `<li>${e}</li>`).join('') : '<li><em>Aucun étudiant</em></li>'}
            </ul>
          `;
          coursList.appendChild(div);
        });
      } catch (err) {
        coursList.innerHTML = '<span class="hint" style="color:#dc2626;">Erreur : ' + err.message + '</span>';
      }
    }

    document.getElementById('filter-input').addEventListener('input', showCours);
    showCours();
  </script>
</body>
</html>
