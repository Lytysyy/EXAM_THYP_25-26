<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des évaluations</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f4f6fb;
      color: #222;
    }
    .container {
      max-width: 700px;
      margin: 32px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 32px 24px;
    }
    h1 {
      text-align: center;
      color: #2a5d9f;
      margin-bottom: 32px;
      font-size: 2.2em;
      letter-spacing: 1px;
    }
    #eval-form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 28px;
      justify-content: center;
    }
    #eval-form input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bcd0ee;
      font-size: 1em;
      box-shadow: 0 2px 8px rgba(42,93,159,0.05);
      transition: border 0.2s;
      margin-bottom: 8px;
    }
    #eval-form input:focus {
      border: 1.5px solid #2a5d9f;
      outline: none;
    }
    #eval-form button {
      background: linear-gradient(90deg,#2a5d9f 80%,#3a7bd5 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(42,93,159,0.09);
      transition: background 0.2s, transform 0.2s;
    }
    #eval-form button:hover {
      background: linear-gradient(90deg,#3a7bd5 80%,#2a5d9f 100%);
      transform: scale(1.04);
    }
    .eval {
      border: 1px solid #e3eaf5;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: linear-gradient(90deg,#f9fbff 80%,#eaf2fb 100%);
      box-shadow: 0 2px 12px rgba(42,93,159,0.07);
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .eval:hover {
      box-shadow: 0 6px 24px rgba(42,93,159,0.13);
      transform: translateY(-2px) scale(1.01);
    }
    .eval h2 {
      margin: 0 0 10px 0;
      color: #2a5d9f;
      font-size: 1.2em;
    }
    .eval-details {
      margin-left: 0;
      padding-left: 18px;
      margin-top: 6px;
    }
    .eval-details strong {
      color: #3a7bd5;
    }
    @media (max-width: 768px) {
      .container { padding: 16px 6px; }
      h1 { font-size: 1.5em; }
      .eval { padding: 12px; }
      #eval-form { gap: 6px; }
    }
    @media (max-width: 400px) {
      .container { padding: 4px; }
      h1 { font-size: 1.1em; }
      .eval h2 { font-size: 1em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Liste des évaluations</h1>
    <div style="margin-bottom:18px;">
      <label for="apiBase" style="font-weight:500;">URL de base API Omeka S :</label>
      <input type="text" id="apiBase" value="http://localhost/omeka_exam/api" style="width:100%;max-width:500px;padding:8px;border-radius:8px;border:1px solid #bcd0ee;">
      <span class="hint">Clés API intégrées automatiquement.</span>
    </div>
    <form id="eval-form">
      <input type="text" id="eval-id" placeholder="Identifiant" required>
      <input type="number" id="eval-note" placeholder="Note" required min="0" max="20" step="0.1">
      <input type="text" id="eval-etudiant" placeholder="Étudiant" required>
      <input type="text" id="eval-cours" placeholder="Cours" required>
      <button type="submit">Ajouter l'évaluation</button>
    </form>
    <div id="evals-list"></div>
    <div id="apiStatus" class="status"></div>
  </div>

  <script>
    // Clés API Omeka S
    const API_KEY_ID = 'NrzdvQnYPeEhGGOqupu9xYLjmSVSF5ee'; // key_identity=NrzdvQnYPeEhGGOqupu9xYLjmSVSF5ee
    const API_KEY_SECRET = 'dvBeCMOZXInzu4QZuVs5q5lYy5OqrLD1';

    function buildApiUrl(path) {
      const baseInput = document.getElementById('apiBase');
      let base = baseInput ? baseInput.value.trim().replace(/\/+$|\/+\(?=api)/g, '') : '';
      if (!base) throw new Error("URL API manquante.");
      // S'assurer que le chemin commence par un '/'
      let pathClean = path.startsWith('/') ? path : '/' + path;
      const url = new URL(base + pathClean);
      url.searchParams.set('key_identity', API_KEY_ID);
      url.searchParams.set('key_credential', API_KEY_SECRET);
      return url.toString();
    }

    async function apiGet(path) {
      const url = buildApiUrl(path);
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) throw new Error(`GET ${url} → ${res.status} ${res.statusText}`);
      return res.json();
    }

    async function apiPost(path, bodyObj) {
      const url = buildApiUrl(path);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bodyObj)
      });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }
      if (!res.ok) {
        throw new Error(`POST ${url} → ${res.status} ${res.statusText}\n${text}`);
      }
      return data;
    }

    // Fonction pour enregistrer une évaluation via l'API Omeka S
    async function setEval(evaluation) {
      const status = document.getElementById('apiStatus');
      status.textContent = 'Enregistrement en cours…';
      status.className = 'status';
      const payload = {
        "dcterms:identifier": [{ "type": "literal", "@value": evaluation.id }],
        "exam:valeurNote": [{ "type": "literal", "@value": evaluation.note }],
        "exam:aPourEtudiant": [{ "type": "literal", "@value": evaluation.etudiant }],
        "exam:aPourCours": [{ "type": "literal", "@value": evaluation.cours }],
        "o:is_public": true
      };
      try {
        await apiPost('/items', payload);
        status.textContent = 'Évaluation enregistrée !';
        status.className = 'status ok';
        showEval();
      } catch (err) {
        status.textContent = 'Erreur : ' + err.message;
        status.className = 'status error';
      }
    }

    // Fonction pour afficher les évaluations via l'API Omeka S
    async function showEval() {
      const status = document.getElementById('apiStatus');
      status.textContent = 'Chargement des évaluations…';
      status.className = 'status';
      try {
        // À adapter : filtre sur le resource template si besoin
        const data = await apiGet('/items');
        const evalsList = document.getElementById('evals-list');
        evalsList.innerHTML = '';
        data.forEach(e => {
          const id = e['dcterms:identifier']?.[0]?.['@value'] || '';
          const note = e['exam:valeurNote']?.[0]?.['@value'] || '';
          const etudiant = e['exam:aPourEtudiant']?.[0]?.['@value'] || '';
          const cours = e['exam:aPourCours']?.[0]?.['@value'] || '';
          const div = document.createElement('div');
          div.className = 'eval';
          div.innerHTML = `
            <h2>Évaluation ${id}</h2>
            <div class="eval-details">
              <strong>Note :</strong> ${note}<br>
              <strong>Étudiant :</strong> ${etudiant}<br>
              <strong>Cours :</strong> ${cours}
            </div>
          `;
          evalsList.appendChild(div);
        });
        status.textContent = `OK – ${data.length} évaluation(s).`;
        status.className = 'status ok';
      } catch (err) {
        status.textContent = 'Erreur : ' + err.message;
        status.className = 'status error';
      }
    }

    // Gestion du formulaire d'ajout
    document.getElementById('eval-form').addEventListener('submit', function(event) {
      event.preventDefault();
      const id = document.getElementById('eval-id').value.trim();
      const note = parseFloat(document.getElementById('eval-note').value);
      const etudiant = document.getElementById('eval-etudiant').value.trim();
      const cours = document.getElementById('eval-cours').value.trim();
      if (id && !isNaN(note) && etudiant && cours) {
        setEval({ id, note, etudiant, cours });
        this.reset();
      }
    });

    // Affichage initial
    showEval();
  </script>
</body>
</html>
