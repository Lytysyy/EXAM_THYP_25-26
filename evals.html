
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>√âvaluations ‚Äì Omeka S</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-page: #f5f5f7;
      --bg-card: #ffffff;
      --border: #e0e0e5;
      --border-strong: #c7c7d0;
      --primary: #2563eb;
      --primary-soft: #e3edff;
      --danger: #dc2626;
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .app {
      width: 100%;
      max-width: 700px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 18px 18px 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .title h1 {
      margin: 0;
      font-size: 19px;
      font-weight: 600;
    }
    .title small {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .tag {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    .card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      margin-bottom: 18px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    fieldset { border: 0; margin: 0; padding: 0; }
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin: 4px 0 4px;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 10px 12px;
      align-items: flex-start;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px 9px;
      border-radius: 9px;
      border: 1px solid var(--border);
      font-size: 13px;
    }
    input::placeholder {
      color: #9ca3af;
    }
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-soft);
      background: #ffffff;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.primary {
      background: var(--primary);
      color: #ffffff;
    }
    button.secondary {
      background: #f3f4f6;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      min-height: 16px;
    }
    .status.error { color: var(--danger); }
    .status.ok { color: #15803d; }
    .eval {
      border: 1px solid #e3eaf5;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      background: linear-gradient(90deg,#f9fbff 80%,#eaf2fb 100%);
      box-shadow: 0 2px 12px rgba(42,93,159,0.07);
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .eval:hover {
      box-shadow: 0 6px 24px rgba(42,93,159,0.13);
      transform: translateY(-2px) scale(1.01);
    }
    .eval h2 {
      margin: 0 0 10px 0;
      color: #2563eb;
      font-size: 1.1em;
    }
    .eval-details strong { color: #3a7bd5; }
    @media (max-width: 768px) {
      .app { padding: 8px 2px; }
      .card { padding: 8px; }
      .eval { padding: 8px; }
    }
  </style>
</head>
<body>
  <div id="notifBox" style="display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);z-index:9999;padding:12px 28px;border-radius:12px;font-size:1.1em;font-weight:500;box-shadow:0 2px 12px rgba(42,93,159,0.13);background:#2563eb;color:#fff;transition:opacity 0.3s;"></div>
  <div class="app">
    <header>
      <div class="title">
        <h1>√âvaluations Omeka S</h1>
        <small>Ajout et affichage des √©valuations (identifiant, note, √©tudiant, cours)</small>
      </div>
      <div class="tag">Instance : Exam</div>
    </header>
    <section class="card">
      <div class="card-title"><span class="icon">‚öôÔ∏è</span> API Omeka S</div>
      <fieldset>
        <div class="row">
          <div>
            <label for="apiBase">URL de base API</label>
            <input id="apiBase" type="text" value="http://localhost/omeka_exam/api" style="width:100%;max-width:500px;padding:8px;border-radius:8px;border:1px solid #bcd0ee;" />
            <span class="hint">Exemple : http://localhost/omeka_exam/api</span>
          </div>
        </div>
      </fieldset>
    </section>
    <section class="card">
      <div class="card-title"><span class="icon">üì¶</span> Ajouter une √©valuation</div>
      <form id="eval-form">
        <div class="row">
          <div>
            <label for="eval-id">Identifiant</label>
            <input type="text" id="eval-id" placeholder="Identifiant" required />
          </div>
          <div>
            <label for="eval-note">Note</label>
            <input type="number" id="eval-note" placeholder="Note" required min="0" max="20" step="0.1" />
          </div>
          <div>
            <label for="eval-etudiant">√âtudiant</label>
            <input type="text" id="eval-etudiant" placeholder="Nom de l'√©tudiant" required />
          </div>
          <div>
            <label for="eval-cours">Cours</label>
            <input type="text" id="eval-cours" placeholder="Identifiant du cours" required />
          </div>
        </div>
        <div class="btn-row">
          <button type="submit" class="primary">Ajouter l'√©valuation</button>
        </div>
      </form>
      <div id="apiStatus" class="status"></div>
    </section>

    <section class="card">
      <div class="card-title"><span class="icon">üë§</span> Ajouter un √©tudiant</div>
      <form id="etudiant-form">
        <div class="row">
          <div>
            <label for="etudiant-nom">Nom de l'√©tudiant</label>
            <input type="text" id="etudiant-nom" placeholder="Nom" required />
          </div>
          <div>
            <label for="etudiant-id">Identifiant</label>
            <input type="text" id="etudiant-id" placeholder="Identifiant" required />
          </div>
        </div>
        <div class="btn-row">
          <button type="submit" class="primary">Cr√©er l'√©tudiant</button>
        </div>
      </form>
      <div id="etudiantStatus" class="status"></div>
      <div style="margin-top:18px;">
        <div class="card-title"><span class="icon">üìë</span> Liste des √©tudiants</div>
        <div id="etudiants-list"></div>
      </div>
    </section>
    <section class="card">
      <div class="card-title"><span class="icon">üìã</span> Liste des √©valuations</div>
      <div id="evals-list"></div>
    </section>
  </div>
  <script>
    // Cl√©s API Omeka S (√† adapter)
    const API_KEY_ID = 'NrzdvQnYPeEhGGOqupu9xYLjmSVSF5ee';
    const API_KEY_SECRET = 'dvBeCMOZXInzu4QZuVs5q5lYy5OqrLD1';

    function buildApiUrl(path) {
      const baseInput = document.getElementById('apiBase');
      const base = baseInput ? baseInput.value.trim().replace(/\/+$|\/+\(?=api)/g, '') : '';
      if (!base) throw new Error("URL API manquante.");
      const url = new URL(base + path);
      url.searchParams.set('key_identity', API_KEY_ID);
      url.searchParams.set('key_credential', API_KEY_SECRET);
      return url.toString();
    }

    async function apiGet(path) {
      const url = buildApiUrl(path);
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) throw new Error(`GET ${url} ‚Üí ${res.status} ${res.statusText}`);
      return res.json();
    }

    async function apiPost(path, bodyObj) {
      const url = buildApiUrl(path);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bodyObj)
      });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }
      if (!res.ok) {
        throw new Error(`POST ${url} ‚Üí ${res.status} ${res.statusText}\n${text}`);
      }
      return data;
    }

    // Fonction pour enregistrer une √©valuation via l'API Omeka S
    function showNotif(message, type = 'ok') {
      const box = document.getElementById('notifBox');
      if (!box) return;
      box.textContent = message;
      box.style.background = type === 'ok' ? '#2563eb' : '#dc2626';
      box.style.color = '#fff';
      box.style.display = 'block';
      box.style.opacity = '1';
      setTimeout(() => {
        box.style.opacity = '0';
        setTimeout(() => { box.style.display = 'none'; }, 400);
      }, 2200);
    }

    async function setEval(evaluation) {
      const status = document.getElementById('apiStatus');
      status.textContent = 'Enregistrement en cours‚Ä¶';
      status.className = 'status';
      const payload = {
        "dcterms:identifier": [{ "type": "literal", "@value": evaluation.id }],
        "exam:valeurNote": [{ "type": "literal", "@value": evaluation.note }],
        "exam:aPourEtudiant": [{ "type": "literal", "@value": evaluation.etudiant }],
        "exam:aPourCours": [{ "type": "literal", "@value": evaluation.cours }],
        "o:is_public": true
      };
      try {
        await apiPost('/items', payload);
        status.textContent = '√âvaluation enregistr√©e !';
        status.className = 'status ok';
        showNotif('√âvaluation enregistr√©e avec succ√®s !', 'ok');
        showEval();
      } catch (err) {
        status.textContent = 'Erreur : ' + err.message;
        status.className = 'status error';
        showNotif('Erreur lors de l\'enregistrement : ' + err.message, 'error');
      }
    }

    // Fonction pour cr√©er un √©tudiant
    async function createEtudiant(nom, identifiant) {
      const status = document.getElementById('etudiantStatus');
      status.textContent = 'Cr√©ation en cours‚Ä¶';
      status.className = 'status';
      const payload = {
        "dcterms:title": [{ "type": "literal", "@value": nom }],
        "dcterms:identifier": [{ "type": "literal", "@value": identifiant }],
        "o:is_public": true,
        "o:resource_class": {"@id": "http://localhost/omeka_exam/api/resource_classes/106"}
      };
      try {
        await apiPost('/items', payload);
        status.textContent = '√âtudiant cr√©√© !';
        status.className = 'status ok';
        showNotif('√âtudiant cr√©√© avec succ√®s !', 'ok');
        showEtudiants();
      } catch (err) {
        status.textContent = 'Erreur : ' + err.message;
        status.className = 'status error';
        showNotif('Erreur lors de la cr√©ation : ' + err.message, 'error');
      }
    }

    // Fonction pour afficher la liste des √©tudiants
    async function showEtudiants() {
      const etudiantsList = document.getElementById('etudiants-list');
      if (!etudiantsList) return;
      etudiantsList.innerHTML = '<span class="hint">Chargement‚Ä¶</span>';
      try {
        // Filtre sur la classe exam:Etudiant (id 106)
        const data = await apiGet('/items?resource_class_id=106');
        if (!Array.isArray(data) || data.length === 0) {
          etudiantsList.innerHTML = '<span class="hint">Aucun √©tudiant trouv√©.</span>';
          return;
        }
        let html = '<ul style="padding-left:18px;">';
        data.forEach(e => {
          const nom = e['dcterms:title']?.[0]?.['@value'] || '(sans nom)';
          const identifiant = e['dcterms:identifier']?.[0]?.['@value'] || '';
          html += `<li><strong>${nom}</strong> <span style="color:#2563eb;">(${identifiant})</span></li>`;
        });
        html += '</ul>';
        etudiantsList.innerHTML = html;
      } catch (err) {
        etudiantsList.innerHTML = '<span class="hint" style="color:#dc2626;">Erreur : ' + err.message + '</span>';
      }
    }

    // Fonction pour afficher les √©valuations via l'API Omeka S
    async function showEval() {
      const status = document.getElementById('apiStatus');
      status.textContent = 'Chargement des √©valuations‚Ä¶';
      status.className = 'status';
      try {
        const data = await apiGet('/items');
        const evalsList = document.getElementById('evals-list');
        evalsList.innerHTML = '';
        data.forEach(e => {
          const id = e['dcterms:identifier']?.[0]?.['@value'] || '';
          const note = e['exam:valeurNote']?.[0]?.['@value'] || '';
          const etudiant = e['exam:aPourEtudiant']?.[0]?.['@value'] || '';
          const cours = e['exam:aPourCours']?.[0]?.['@value'] || '';
          const div = document.createElement('div');
          div.className = 'eval';
          div.innerHTML = `
            <h2>√âvaluation ${id}</h2>
            <div class="eval-details">
              <strong>Note :</strong> ${note}<br>
              <strong>√âtudiant :</strong> ${etudiant}<br>
              <strong>Cours :</strong> ${cours}
            </div>
          `;
          evalsList.appendChild(div);
        });
        status.textContent = `OK ‚Äì ${data.length} √©valuation(s).`;
        status.className = 'status ok';
      } catch (err) {
        status.textContent = 'Erreur : ' + err.message;
        status.className = 'status error';
      }
    }

    // Gestion du formulaire d'ajout d'√©valuation
    document.getElementById('eval-form').addEventListener('submit', function(event) {
      event.preventDefault();
      const id = document.getElementById('eval-id').value.trim();
      const note = parseFloat(document.getElementById('eval-note').value);
      const etudiant = document.getElementById('eval-etudiant').value.trim();
      const cours = document.getElementById('eval-cours').value.trim();
      if (id && !isNaN(note) && etudiant && cours) {
        setEval({ id, note, etudiant, cours });
        this.reset();
      }
    });

    // Gestion du formulaire d'ajout d'√©tudiant
    document.getElementById('etudiant-form').addEventListener('submit', function(event) {
      event.preventDefault();
      const nom = document.getElementById('etudiant-nom').value.trim();
      const identifiant = document.getElementById('etudiant-id').value.trim();
      if (nom && identifiant) {
        createEtudiant(nom, identifiant);
        this.reset();
      }
    });

    // Affichage initial de la liste des √©tudiants
    showEtudiants();

    // Affichage initial
    showEval();
  </script>
</body>
</html>
